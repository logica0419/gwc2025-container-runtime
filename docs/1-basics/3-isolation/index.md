# 1-3. プロセス隔離

前節では、プロセスについて詳しく見ていきました。  
[1-1](/1-basics/1-container)で述べたように、コンテナは

> **プロセスツリーのある枝から先を、Namespaceやchroot/pivot_root、cgroupなどの機能を使って隔離して実行したもの**

です。すなわち、コンテナを実現するためには**プロセスを隔離**する技術が必要です。

プロセスを隔離するというのは、主に子プロセスから親プロセスの「何かしら」を**操作できなくする・操作を制限する**ことを指します。「何かしら」に当てはまるものは多く、それぞれに対して**別の機能**が実装されています。  
この節では、Linuxに実装されているプロセス隔離機能について解説します。

## Namespace

プロセス隔離の代名詞、Namespace。  
OS内の**様々なリソースの管理**を、独立したNamespaceに切り分けることで

- Namespace内からホストのリソースが**閲覧できない**
- Namespace内でのリソースの変更がホストに**影響を与えない**

といったことが実現できます。  
Namespaceは**プロセス単位**の概念で、あるプロセスが独立したNamespaceに所属すると、**子プロセスも**自動的にその**Namespaceに所属**します。

現在Namespaceは以下の**8つのリソース**に対して指定できます。

| Namespace | 隔離するリソース               |
| --------- | ------------------------------ |
| Cgroup    | cgroup (後述)                  |
| IPC       | プロセス間通信                 |
| Network   | ネットワークデバイス・アドレス |
| Mount     | マウント情報                   |
| PID       | プロセスID                     |
| Time      | システムクロックの一部         |
| User      | ユーザー                       |
| UTS       | hostname                       |

これらのNamespaceは、ユーザーが好きに**組み合わせを選んで**使うことができます。

## chroot・pivot_root

chroot・pivot_rootは、どちらも**ファイルシステムのルートを変える**機能です。  
`/`**が別の場所にある**と登録することで、ホスト側のファイルは**閲覧・編集できなく**なります。  
後程触れますが、これらは**同じ機能を違う方法**で実現しています。

例えばこれらの機能を使い「`/home/container/tmp`がこれからは`/`だ」と設定すれば、設定されたプロセスは`/home/container/tmp`以下のファイルしか**閲覧できなく**なります。

これも**プロセス単位**の概念で、あるプロセスのルートディレクトリを変更すれば、その**子プロセスも**自動的に**そこがルートディレクトリになり**ます。

## cgroup

cgroupことControl Groupは、あるプロセスが**使うことのできるリソース量を制限**するための機能です。  
Namespaceの対象となるリソースと違い、**全体で共有しておりはっきりと分離ができない**リソースが対象で、**CPU**・**メモリ**・ストレージのアクセス速度、パケットの制御などが該当します。

コンテナにおいては、主に**CPUとメモリの使用量を制限**するために使われています。  
これも**プロセス単位**の概念で、あるプロセスをあるcgroupに入れれば、その**子プロセスも**自動的に**そのcgroupに所属**し、所属したプロセス**全体の合計量が制限**を受けます。

## その他の隔離機能

現代のコンテナでは、以下のような隔離機能も利用されています。

- Seccomp: 呼ぶことのできる**syscall** ([1-4](/1-basics/4-syscall)) を制限
- Capabilities: Linuxの中での**プロセスの権限**を設定

これらは今回のワークショップでは扱わないため、是時各自で調べてみて下さい。
