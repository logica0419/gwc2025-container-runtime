# 1-5. 改めて: コンテナって何だ？

## コンテナの正体

さあ、ここまでの基礎を理解していれば、冒頭の**コンテナの定義**が何を示しているか理解できるはずです。

> **プロセスツリーのある枝から先を、Namespaceやchroot/pivot_root、cgroupなどの機能を使って隔離して実行したもの**

![コンテナのイメージ](./1.dio.png)

図のように**プロセスを隔離**すれば、その子プロセスを含めた**プロセスグループ**が**コンテナとして振る舞う**のです。  
言い換えれば、あるプロセスに対して

- Namespaceでリソース管理をホストと分ける
- chroot/pivot_rootでルートディレクトリを変更する
- cgroupで計算リソース制限をかける
- その他Seccompなどセキュリティ面の制限をかける

などの処理を施せば、それはもう**立派なコンテナ**なのです。

## コンテナイメージ

コンテナを便利に扱うために発明されたのが、**コンテナイメージ**という概念です。

コンテナイメージは、構築したいコンテナの`/`**配下のファイル群をひとまとめにした**ものです。  
ハンズオンパートでもやりますが、このイメージの中にあるファイルを**任意のディレクトリに展開**し、そのディレクトリをchroot・pivot_rootを使って**ルートディレクトリに指定**することで、同じ環境を持ったコンテナを**様々な場所で複製・再現**できます。  
これによって、動かしたいソフトウェアの**バイナリ**と、動かすための**環境**を一緒に配布できるのです。

![コンテナイメージ](./2.dio.png)

もちろん、ただファイルを圧縮しただけのzipやtarとは異なり、効率の良い保存・転送のために**レイヤーに分けて**データを持っていたり、対応しているCPUアーキテクチャ等を**メタデータ**として持っていたりします。  
これらイメージの中身は、各種コンテナランタイムやコンテナレジストリ (イメージの保管庫) で**互換性を保つ**ことができるよう、[OCI Image Spec](https://specs.opencontainers.org/image-spec/)という**共通規格**が定められています。  
興味が湧いたらぜひ見てみて下さい。

### なぜ様々なOSのイメージが存在するのか

ここまできてようやく、皆さんが良く抱く疑問「コンテナのOSは**Linuxだけ**と言われているのに、なぜUbuntuやAlpine、CentOSなど『**様々なOS**』**のイメージ**が存在するのか」に答えることができます。  
[1-2](/1-basics/2-os/)で説明した、カーネルとOS (ディストリビューション) の関係を思い出してください。

![OSとディストリビューション](./3.dio.png)

コンテナを構成する**プロセス管理**/**プロセス隔離**の機能は**Linuxカーネルが提供**しています。  
すなわち、コンテナの作成処理には、カーネル以外**関係ない**のです。

また、各ディストリビューションをそれたらしめているのは**シェルやコマンド、ライブラリ**といったカーネル以外の部品であり、これらは全て**ファイル**として提供されています。  
すなわち、ディストリビューションが**配布しているファイル群**を**そのままコンテナイメージ**にすれば、**ホストのカーネル**の上で動くプロセス (コンテナ) が**異なるディストリビューション**を動かすことができるのです。

ただし、コンテナの作成処理にはLinuxカーネルが必要なため、Linuxカーネルを**ベースとしない**OS (WindowsやmacOS) をコンテナで動かすことは**できません**。

## コンテナランタイムに求められる役割

プロセスを隔離し、コンテナに仕立て上げるのが**コンテナランタイムの仕事**です。  
しかし、それだけでは**便利で実用的なコンテナ**とはなりません。

今のコンテナを取り巻くエコシステムが複雑に見えるのは、コンテナを便利に扱うため、様々な個人・団体が努力を重ねてきた証なのです。  
次節では座学編のまとめとして、コンテナランタイムの**歴史**と今の**エコシステム**について学んでいきましょう。
